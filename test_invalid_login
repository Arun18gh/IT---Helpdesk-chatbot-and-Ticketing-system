import unittest
from app import app
from config import users_collection
from werkzeug.security import generate_password_hash

TEST_USERNAME = "invalid_login_user"
CORRECT_PASSWORD = "CorrectPass123"
WRONG_PASSWORD = "WrongPass123"

class InvalidLoginTest(unittest.TestCase):

    def setUp(self):
        self.client = app.test_client()
        app.config['TESTING'] = True
        users_collection.delete_many({"username": TEST_USERNAME})
        users_collection.insert_one({
            "username": TEST_USERNAME,
            "password": generate_password_hash(CORRECT_PASSWORD),
            "role": "user"
        })

    def test_login_with_wrong_password(self):
        response = self.client.post("/login", data={
            "username": TEST_USERNAME,
            "password": WRONG_PASSWORD
        }, content_type='application/x-www-form-urlencoded', follow_redirects=True)

        self.assertIn(b"invalid credentials", response.data.lower())

    def tearDown(self):
        users_collection.delete_many({"username": TEST_USERNAME})

if __name__ == "__main__":
    unittest.main()